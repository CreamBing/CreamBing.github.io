---
title: springcloud编写用户微服务
date: 2018-10-26 13:53:48
tags:
- java
- springcloud
- h2
- jooq
categories:
- java
- 微服务
- springcloud
- 实战
comments: true
---
# 前言
1.springcloud Finchley.SR2版本
2.springboot 版本2.0.6.RELEASE
3.h2
4.jooq
5.consul
搭建一个用户微服务
# 目的
利用idea快速搭建一个springcloud集成上述功能的微服务，可以查询用户
<!-- more -->

# 正文
## 初始化工程
方法跟**{% post_link springcloud集成consul %}**中前期准备工程一般，勾选下列依赖
{% img /images/java/springcloud/consul/user/idea_build.png %}
在resources文件夹下新增bootstrap.yml文件，写入以下内容
```
#tomcat启动启动端口
server:
  port: 1016
spring:
  application:
    #项目名称
    name: consul-user
  cloud:
    consul:
      #consul server的host或者ip
      host: localhost
      #consul server的端口
      port: 18500
      config:
        #开启consul配置中心
        enabled: true
        #consul表示consul上面文件的格式 有四种 YAML PROPERTIES KEY-VALUE FILES
        format: YAML
        #表示consul上面的KEY值(或者说文件的名字) 默认是data
        data-key: configuration
        #prefix设置配置值的基本文件夹
        prefix: config
        #defaultContext设置所有应用程序使用的文件夹名
        default-context: ${spring.application.name}
      discovery:
        #开启consul服务发现
        enabled: true
        #开启consul服务的名称
        service-name: consul-user
        #服务检查的路径
        health-check-path: /actuator/health
        #服务检查的时间间隔
        health-check-interval: 10s
        #服务检查的完整路径
        health-check-url: http://192.168.0.101:${server.port}${spring.cloud.consul.discovery.health-check-path}
        tags: dev
```
启动主工程,查看consul ui发现程序正常注册
{% img /images/java/springcloud/consul/user/consul_ui.png %}
<font color="#eb4d4b">如果程序未能正常注册，查看程序是否正常启动或者这里的ip需要写成程序所在机器的ip,consul集群所在的机器能够访问</font>
{% img /images/java/springcloud/consul/user/consul_ui_fail.png %}

## 初始化H2数据库
由于已经使用了consul作为配置中心,直接在consul配置界面新增如下配置
{% img /images/java/springcloud/consul/user/consul_h2.png %}
启动之后发现datasource循环依赖
{% img /images/java/springcloud/consul/user/consul_datasource_circle.png %}
这时候决定手动初始化datasource,同时集成第三方数据库连接池进来，详情**{% post_link springboot集成druid %}**
此时consul上的配置如下
```
spring:
  datasource:
    url: jdbc:h2:mem:test #内存
    #url: jdbc:h2:file:~/.h2/testdb #文件
    driverClassName: org.h2.Driver
    username: sa
    password: 123456
    platform: h2
    schema: classpath:db/schema.sql
    data: classpath:db/data.sql
    initialization-mode: always #springboot2.0加上上述sql才会执行
    # 下面为druid连接池的补充设置，应用到上面所有数据源中
    # 初始化大小，最小，最大
    initialSize: 1
    minIdle: 3
    maxActive: 20
    # 配置获取连接等待超时的时间
    maxWait: 60000
    # 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒
    timeBetweenEvictionRunsMillis: 60000
    # 配置一个连接在池中最小生存的时间，单位是毫秒
    minEvictableIdleTimeMillis: 30000
    validationQuery: select 'x'
    testWhileIdle: true
    testOnBorrow: false
    testOnReturn: false
    # 打开PSCache，并且指定每个连接上PSCache的大小
    poolPreparedStatements: true
    maxPoolPreparedStatementPerConnectionSize: 20
    # 配置监控统计拦截的filters，去掉后监控界面sql无法统计
    filters: stat
    # 通过connectProperties属性来打开mergeSql功能；慢SQL记录
    connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000
    # 合并多个DruidDataSource的监控数据
    useGlobalDataSourceStat: true 
  h2:
    console:
      settings:
        web-allow-others: true #进行该配置后，h2 web consloe就可以在远程访问了。否则只能在本机访问。
      path: /h2-console #进行该配置，你就可以通过YOUR_URL/h2-console访问h2 web consloe。YOUR_URL是你程序的访问URl。
      enabled: true #进行该配置，程序开启时就会启动h2 web consloe。当然这是默认的，如果你不想在启动程序时启动h2 web consloe，那么就设置为false。
logging:
  level:
    root: INFO
    org.hibernate: INFO
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.hibernate.type.descriptor.sql.BasicExtractor: TRACE
```
根据配置在resources目录下，新增db文件夹，下面新增schema.sql和data.sql文件，内容分别如下
```
drop table user if exists;
create table user (id bigint generated by default as identity ,username varchar(40),name varchar(20),age int(3),balance decimal(10,2),primary key (id));

insert into user (id,username,name,age,balance) values (1,'admin','zb',20,100.00);
insert into user (id,username,name,age,balance) values (2,'liuman','柳曼',20,101.00);
```
在主程序平级目录新增db目录，新增DataSourceBean.java和DatasourceConf.java
```
@Configuration
@Component
@Data
public class DataSourceBean {

    private static final Logger LOGGER = LoggerFactory.getLogger(DataSourceBean.class);

    @Autowired
    DatasourceConf datasourceConf;

    @Bean
    public DataSource getDataSource() {
        DruidDataSource datasource = new DruidDataSource();
        datasource.setUrl(datasourceConf.getUrl());
        datasource.setUsername(datasourceConf.getUsername());
        datasource.setPassword(datasourceConf.getPassword());
        datasource.setDriverClassName(datasourceConf.getDriverClassName());
        //configuration
        datasource.setInitialSize(datasourceConf.getInitialSize());
        datasource.setMinIdle(datasourceConf.getMinIdle());
        datasource.setMaxActive(datasourceConf.getMaxActive());
        datasource.setMaxWait(datasourceConf.getMaxWait());
        datasource.setTimeBetweenEvictionRunsMillis(datasourceConf.getTimeBetweenEvictionRunsMillis());
        datasource.setMinEvictableIdleTimeMillis(datasourceConf.getMinEvictableIdleTimeMillis());
        datasource.setValidationQuery(datasourceConf.getValidationQuery());
        datasource.setTestWhileIdle(datasourceConf.getTestWhileIdle());
        datasource.setTestOnBorrow(datasourceConf.getTestOnBorrow());
        datasource.setTestOnReturn(datasourceConf.getTestOnReturn());
        datasource.setPoolPreparedStatements(datasourceConf.getPoolPreparedStatements());
        datasource.setMaxPoolPreparedStatementPerConnectionSize(datasourceConf.getMaxPoolPreparedStatementPerConnectionSize());
        datasource.setUseGlobalDataSourceStat(datasourceConf.getUseGlobalDataSourceStat());
        try {
            datasource.setFilters(datasourceConf.getFilters());
        } catch (SQLException e) {
            LOGGER.error("druid configuration initialization filter: " + e);
        }
        datasource.setConnectionProperties(datasourceConf.getConnectionProperties());
        return datasource;
    }

    /**
     * 配置监控服务器
     *
     * @return 返回监控注册的servlet对象
     */
    @Bean
    public ServletRegistrationBean statViewServlet() {
        ServletRegistrationBean servletRegistrationBean = new ServletRegistrationBean(new StatViewServlet(), "/druid/*");
        // 添加IP白名单
        servletRegistrationBean.addInitParameter("allow", "192.168.14.32,127.0.0.1");
        // 添加IP黑名单，当白名单和黑名单重复时，黑名单优先级更高
        servletRegistrationBean.addInitParameter("deny", "192.168.14.32");
        // 添加控制台管理用户
        servletRegistrationBean.addInitParameter("loginUsername", "druid");
        servletRegistrationBean.addInitParameter("loginPassword", "123456");
        // 是否能够重置数据
        servletRegistrationBean.addInitParameter("resetEnable", "false");
        return servletRegistrationBean;
    }

    /**
     * 配置服务过滤器
     *
     * @return 返回过滤器配置对象
     */
    @Bean
    public FilterRegistrationBean statFilter() {
        FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean(new WebStatFilter());
        // 添加过滤规则
        filterRegistrationBean.addUrlPatterns("/*");
        // 忽略过滤格式
        filterRegistrationBean.addInitParameter("exclusions", "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*,");
        return filterRegistrationBean;
    }
}

@ConfigurationProperties(prefix = "spring.datasource")
@Component
@Data
public class DatasourceConf {

    private String url;
    private String username;
    private String password;
    private String driverClassName;
    private int initialSize;
    private int minIdle;
    private int maxActive;
    private int maxWait;
    private int timeBetweenEvictionRunsMillis;
    private int minEvictableIdleTimeMillis;
    private String validationQuery;
    private Boolean testWhileIdle;
    private Boolean testOnBorrow;
    private Boolean testOnReturn;
    private Boolean poolPreparedStatements;
    private int maxPoolPreparedStatementPerConnectionSize;
    private String filters;
    private String connectionProperties;
    private Boolean useGlobalDataSourceStat;
}
```
重新启动主程序，此时会报一个小错，具体原因是由于druid开启了如下配置，当数据库为h2并且需要执
行新增表操作时，sql统计分析会合并异常，具体看{% link github上面的issue https://github.com/alibaba/druid/issues/1686 %}
```
# 配置监控统计拦截的filters，去掉后监控界面sql无法统计
filters: stat
```
{% img /images/java/springcloud/consul/user/druid_stat_error.png %}
检查
1.查看h2 ui,是否user表和数据是否写入 http://localhost:1016/h2-console/
2.查看druid监控页面 http://127.0.0.1:1016/druid/sql.html
{% img /images/java/springcloud/consul/user/h2_ui.png %}
{% img /images/java/springcloud/consul/user/druid_sql_stat.png %}

## 集成jooq generate工具
具体教程可见**{% post_link springboot集成jooq %}**
<font color="#2ecc71" size="4"><i class="fa fa-spinner fa-spin"></i>扩展</font>
在maven package时，由于集成了jooq generate工具，会执行一遍，这样如果自己修改了相关类会被还原，所以在打包时希望不执行相关驱动可以加如下配置
<font color="#eb4d4b">放在pom驱动配置的configuration标签内</font>
{% codeblock %}
<!-- install 跳过 -->
<skip>true</skip>
{% endcodeblock %}
{% img /images/java/springcloud/consul/user/package_skip_plugins.jpg %}
在打包的过程中，执行了springboot中的一些test，当从consul上远程读取yml配置时爆了如下错，忽略测试打包成功后，启动工程仍然报错，然而idea中自己run的时候却没有报错
对比了相关命令
{% img /images/java/springcloud/consul/user/consul_config_utf8_fail.png %}
远程yml配置中含有中文，务必在使用java -Dfile.encoding=UTF-8 -jar .\consul-user-0.0.1-SNAPSHOT.jar指定utf8编码
不然打包会失败，启动失败，会报上面的错
https://github.com/jOOQ/jOOQ/blob/master/jOOQ-examples/jOOQ-spring-example/pom.xml
